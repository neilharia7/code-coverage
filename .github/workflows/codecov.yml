name: Codecov Coverage

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  codecov:
    name: Upload Coverage to Codecov
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better path fixing

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Parse coverage and create quality gate report
        id: coverage
        run: |
          # Parse coverage from coverage-summary.json (most reliable)
          if [ -f ./coverage/coverage-summary.json ]; then
            LINE_COVERAGE=$(node -p "const data = require('./coverage/coverage-summary.json'); data.total.lines.pct.toFixed(2)")
            COVERED_LINES=$(node -p "const data = require('./coverage/coverage-summary.json'); data.total.lines.covered")
            MISSED_LINES=$(node -p "const data = require('./coverage/coverage-summary.json'); data.total.lines.total - data.total.lines.covered")
            TOTAL_LINES_OUT=$(node -p "const data = require('./coverage/coverage-summary.json'); data.total.lines.total")
          else
            # Fallback: Parse from Jest text output
            COVERAGE_OUTPUT=$(npm run test:coverage 2>&1 || true)
            LINE_COVERAGE=$(echo "$COVERAGE_OUTPUT" | grep -E "All files" | awk '{print $4}' | sed 's/%//' || echo "0")
            MISSED_LINES=$(echo "$COVERAGE_OUTPUT" | grep -E "All files" | awk '{print $6}' || echo "0")
            COVERED_LINES="N/A"
            TOTAL_LINES_OUT="N/A"
          fi
          
          # Quality gate threshold (80%)
          THRESHOLD=80
          COVERAGE_INT=$(echo "$LINE_COVERAGE" | cut -d. -f1)
          
          if [ -z "$COVERAGE_INT" ] || [ "$COVERAGE_INT" = "" ]; then
            COVERAGE_INT=0
          fi
          
          if [ "$COVERAGE_INT" -ge "$THRESHOLD" ]; then
            STATUS="SUCCESS"
            STATUS_ICON="‚úî"
          else
            STATUS="FAILURE"
            STATUS_ICON="‚úñ"
          fi
          
          echo "coverage=$LINE_COVERAGE" >> $GITHUB_OUTPUT
          echo "missed_lines=$MISSED_LINES" >> $GITHUB_OUTPUT
          echo "covered_lines=$COVERED_LINES" >> $GITHUB_OUTPUT
          echo "total_lines=$TOTAL_LINES_OUT" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "status_icon=$STATUS_ICON" >> $GITHUB_OUTPUT
          echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
          
          echo "Coverage: $LINE_COVERAGE%"
          echo "Status: $STATUS"

      - name: Generate coverage report comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const missedLines = '${{ steps.coverage.outputs.missed_lines }}';
            const coveredLines = '${{ steps.coverage.outputs.covered_lines }}';
            const totalLines = '${{ steps.coverage.outputs.total_lines }}';
            const status = '${{ steps.coverage.outputs.status }}';
            const statusIcon = '${{ steps.coverage.outputs.status_icon }}';
            const threshold = '${{ steps.coverage.outputs.threshold }}';
            
            const coverageFloat = parseFloat(coverage);
            const thresholdFloat = parseFloat(threshold);
            const coveragePercent = coverageFloat.toFixed(2);
            
            // Calculate coverage percentage for progress bar
            const coverageBar = Math.round(coverageFloat / 100 * 20); // 20 chars for 100%
            const missedBar = 20 - coverageBar;
            const coverageBarStr = '‚ñà'.repeat(Math.max(0, coverageBar));
            const missedBarStr = '‚ñë'.repeat(Math.max(0, missedBar));
            
            // Determine status color
            const statusColor = status === 'SUCCESS' ? 'üü¢' : 'üî¥';
            const statusText = status === 'SUCCESS' ? 'SUCCESS' : 'FAILURE';
            
            // Calculate covered lines
            const coveredLinesNum = coveredLines !== 'N/A' ? parseInt(coveredLines) : (totalLines !== 'N/A' && missedLines !== 'N/A' ? parseInt(totalLines) - parseInt(missedLines) : 'N/A');
            
            const comment = `## üìä Quality Monitor - Line Coverage: ${coveragePercent}%
            
            **Coverage Summary:**
            - **Line Coverage:** ${coveragePercent}% (${missedLines} missed lines)
            
            **Visual Progress:**
            \`\`\`
            ${coverageBarStr}${missedBarStr} ${coveragePercent}%
            \`\`\`
            
            **Quality Gates:** ${statusColor}
            - **Overall Status:** ${statusIcon} ${statusText}
            - **Passed Gates:** ${statusIcon} ${status === 'SUCCESS' ? 'Passed' : 'Failed'}
              - ${statusIcon} **Line:** ${coveragePercent}% ${coverageFloat >= thresholdFloat ? '>=' : '<'} ${threshold}%
            
            **Details:**
            | Metric | Value |
            |--------|-------|
            | Line Coverage | ${coveragePercent}% |
            | Covered Lines | ${coveredLinesNum} |
            | Missed Lines | ${missedLines} |
            | Total Lines | ${totalLines} |
            
            **Quality Gate Threshold:** ${threshold}%
            
            ---
            *Created by Quality Monitor v1.0.0*
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Quality Monitor - Line Coverage')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          # Coverage files to upload (lcov.info is generated by Jest)
          files: ./coverage/lcov.info
          
          # Directory containing coverage reports
          directory: ./coverage
          
          # Token for authentication (set CODECOV_TOKEN in repository secrets)
          # For public repos, token is optional if global upload token is enabled
          token: ${{ secrets.CODECOV_TOKEN }}
          
          # Flag to identify this coverage report type
          flags: unittests
          
          # Name for this coverage upload
          name: codecov-umbrella
          
          # Fail CI if upload fails
          fail_ci_if_error: true
          
          # Enable verbose logging for detailed debugging
          verbose: true
          
          # Environment variables to include in the report
          env_vars: NODE_VERSION,OS
          
          # Override branch name (useful for PRs)
          override_branch: ${{ github.head_ref || github.ref_name }}
          
          # Override commit SHA
          override_commit: ${{ github.event.pull_request.head.sha || github.sha }}
          
          # Override PR number if this is a PR
          override_pr: ${{ github.event.pull_request.number }}
          
          # Build URL for linking back to CI
          override_build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          # Root directory for path resolution
          root_dir: ./
          
          # Network filter for files (only include src directory)
          network_filter: src/
          
          # Network prefix for path resolution
          network_prefix: ./
          
          # Skip validation (set to false for security)
          skip_validation: false
          
          # Report type (coverage is default)
          report_type: coverage
          
          # Working directory
          working-directory: ./
          
          # Specify which CLI command to run
          run_command: upload-coverage
          
          # Enable path fixing for better file matching
          # This helps Codecov correctly identify files across different environments
          # Path fixing is enabled by default in v5

      - name: Fail if coverage below threshold
        if: steps.coverage.outputs.status == 'FAILURE'
        run: |
          echo "‚ùå Coverage is below the ${{ steps.coverage.outputs.threshold }}% threshold!"
          echo "Current coverage: ${{ steps.coverage.outputs.coverage }}%"
          exit 1
