name: Codecov Coverage

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  codecov:
    name: Upload Coverage to Codecov
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better path fixing

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          # Coverage files to upload (lcov.info is generated by Jest)
          files: ./coverage/lcov.info
          
          # Directory containing coverage reports
          directory: ./coverage
          
          # Token for authentication (set CODECOV_TOKEN in repository secrets)
          # For public repos, token is optional if global upload token is enabled
          token: ${{ secrets.CODECOV_TOKEN }}
          
          # Flag to identify this coverage report type
          flags: unittests
          
          # Name for this coverage upload
          name: codecov-umbrella
          
          # Fail CI if upload fails
          fail_ci_if_error: true
          
          # Enable verbose logging for detailed debugging
          verbose: true
          
          # Environment variables to include in the report
          env_vars: NODE_VERSION,OS
          
          # Override branch name (useful for PRs)
          override_branch: ${{ github.head_ref || github.ref_name }}
          
          # Override commit SHA
          override_commit: ${{ github.event.pull_request.head.sha || github.sha }}
          
          # Override PR number if this is a PR
          override_pr: ${{ github.event.pull_request.number }}
          
          # Build URL for linking back to CI
          override_build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          # Root directory for path resolution
          root_dir: ./
          
          # Network filter for files (only include src directory)
          network_filter: src/
          
          # Network prefix for path resolution
          network_prefix: ./
          
          # Skip validation (set to false for security)
          skip_validation: false
          
          # Report type (coverage is default)
          report_type: coverage
          
          # Working directory
          working-directory: ./
          
          # Specify which CLI command to run
          run_command: upload-coverage
          
          # Enable path fixing for better file matching
          # This helps Codecov correctly identify files across different environments
          # Path fixing is enabled by default in v5
